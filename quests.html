<!DOCTYPE html>
<html lang="en" class="h-100">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="Waterdeep Project - Quests">
    <meta name="author" content="Evan Carraway">
    <title>Waterdeep - Quests</title>
    <style>
        /* Embedded CSS for Styling */
        #quest-humorous-desc {
            font-style: italic;
            padding: 15px;
            border-left: 4px solid #14110d;
            margin: 20px 0;
            /* background-color: #fef8f0; */
            quotes: "“" "”";
        }
        #quest-humorous-desc::before {
            content: open-quote;
            font-size: 1.5em;
            font-weight: bold;
            /* color: #d2b48c; */
        }
        #quest-humorous-desc::after {
            content: close-quote;
            font-size: 1.5em;
            font-weight: bold;
            /* color: #d2b48c; */
        }
        #quest-aliases {
            font-size: 0.9em;
            font-style: italic;
            /* color: #d2b48c; */
        }
    </style>
    <link href="css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="css/sticky-footer-navbar.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css"/>  
    <script src="https://www.gstatic.com/charts/loader.js"></script>
  </head>

  <body  style="width:100%">
    <div id="header"></div>

    <main style="width:100%">
      <div hidden id="quest-container"  class="container" style="width:100%; padding-top:60px;">
        <h1 id="quest-title"  class="container" style="text-align:center;padding-bottom:30px;vertical-align:middle"></h1>
        <div id="quest-arrows-top"  class="container" style="padding-top:10px;padding-bottom:30px;">
          <div style="text-align: center;">
            <a href="quests.html" class="btn btn-primary">← Back to All Quests</a>
          </div>
        </div>
        <div id="quest-body" class="p-3 border rounded shadow-sm bg-light" style="width:100%">
        </div>
        <div id="quest-arrows-bottom"  class="container" style="padding-top:30px;padding-bottom:30px;">
          <div style="text-align: center;">
            <a href="quests.html" class="btn btn-primary">← Back to All Quests</a>
          </div>
        </div>
      </div>
      
      <div hidden id="table-container" class="container" style="padding-top:60px;">  
        <h1 class="text-center" style="padding-bottom:30px;">All Quests</h1>
        <table id="data-table" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Image</th>
              <th>chapter</th>
              <th>Name</th>
              <th>Full Name</th>
              <th>Originator</th>
              <th>Category</th>
              <th>Status</th>
              <th>Description</th>
            </tr>
          </thead>
        </table>
      </div>  
    </main>

    <footer class="footer mt-auto py-3 bg-white">
      <div class="container-fluid">
        <span class="text-muted">© Carraway 2025</span>
      </div>
    </footer>
    
    <script src="js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="js/jquery-3.6.0.js"></script> 
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
	  <script>
      $(function(){
        $("#header").load("header.html",  function(){
          document.getElementById("quests").classList.add('active'); // Assuming an 'quests' link in header.html
        });
      });
    </script>
    <script>
       $(document).ready(function() {
        var searchParams = new URLSearchParams(window.location.search);
        var quest_key = searchParams.has("i") ? searchParams.get("i") : 0;
        
        google.charts.load('current',{'packages':['corechart','table']});
        google.charts.setOnLoadCallback(drawAllSheets);

        async function fetchItemData(filename) {
            // Placeholder for a full fetch function. In a real environment, this URL would be updated.
            const res = await fetch(filename);
            return await res.json();
        }

        async function drawAllSheets() {
          let quest_data_full = [];
          
          // 1. Fetch the main quest list
          const [quests_short, locations_short, items_short, characters_short] = await Promise.all([
              fetchItemData('https://epcarraway.blob.core.windows.net/dnd/quest/quests_short.json'),
              fetchItemData('https://epcarraway.blob.core.windows.net/dnd/location/locations_short.json'),
              fetchItemData('https://epcarraway.blob.core.windows.net/dnd/item/items_short.json'),
              fetchItemData('https://epcarraway.blob.core.windows.net/dnd/char/chars.json')
          ]);
          
          // 2. Build Character Lookup Map (Name/Full Name -> name_key)
          // We use a Map to handle case-insensitive matching if needed, but direct string matching is usually safer for generated data.
          // This ensures if "Johnny 5" appears in the location list, we know his key is "johnny5"
          let charLinkMap = new Map();
          if (Array.isArray(characters_short)) {
              characters_short.forEach(c => {
                  if (c.name && c.name_key) charLinkMap.set(c.name.trim(), c.name_key);
                  if (c.full_name && c.name_key) charLinkMap.set(c.full_name.trim(), c.name_key);
              });
          }

          // B. Location Map (Name -> location_key)
          let locLinkMap = new Map();
          if (Array.isArray(locations_short)) {
              locations_short.forEach(l => {
                  if (l.name && l.location_key) {
                      // We replace commas to match the URL format used in the Table View
                      locLinkMap.set(l.name.trim(), l.location_key.replace(",", ""));
                  }
              });
          }

          // C. Item Map (Name -> item_key)
          let itemLinkMap = new Map();
          if (Array.isArray(items_short)) {
              items_short.forEach(i => {
                  if (i.name && i.item_key) {
                      // We replace commas to match the URL format used in the Table View
                      itemLinkMap.set(i.name.trim(), i.item_key.replace(",", ""));
                  }
                  if (i.full_name && i.item_key) itemLinkMap.set(i.full_name.trim(), i.item_key.replace(",", ""));
              });
          }

          if (quest_key === 0) {
            // --- Table View Mode ---
            document.getElementById("table-container").hidden = false;
            let unique_quests = new Map();

            // Aggregate unique quests and find the best single description
            quests_short.forEach(quest => {
                // If this is the first time seeing the quest_key, or this entry is "rarer"
                if (!unique_quests.has(quest.quest_key) || (quest.originator > unique_quests.get(quest.quest_key).originator)) {
                    unique_quests.set(quest.quest_key, quest);
                }
            });

            let tableRows = [];
            unique_quests.forEach((quest, key) => {
                let chapterNumber = quest.ch_num;
                let chapterNumberUrl = '<a href="chapters.html?c=' + chapterNumber + '">' + chapterNumber + '</a>'
                let questUrl = '<a href="quests.html?i=' + key + '">' + quest.name + '</a>';
                let thumbnailUrl = '<a href="quests.html?i=' + key + '"><img src="https://epcarraway.blob.core.windows.net/dnd/quest/' + key + '-200.jpg" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/80x80.jpg?text=No+Image\';" style="width:80px"></a>';
                let categoryDisplay = Array.isArray(quest.category) ? quest.category.join(', ') : quest.category;
                //let statusDisplay = Array.isArray(quest.status) ? quest.status.join(', ') : quest.status;
                //console.log(questUrl)
                //console.log(statusDisplay)
                tableRows.push([
                    thumbnailUrl,
                    chapterNumberUrl,
                    questUrl,
                    quest.name,
                    quest.originator,
                    categoryDisplay,
                    quest.status,
                    quest.short_description
                ]);
            });
            //console.log(tableRows)
            $('#data-table').DataTable( {
              paging: true,
              pageLength: 100,
              order: [[1, 'desc']],
              data: tableRows,
              columns: [
                { "title": "Image" },
                { 
                  "title": "chapter",
                  "className": 'dt-body-center',
                  "render": function(title, type, row, meta){
                    if(type === 'display'){
                        title = title;
                    }
                    
                    return title;
                  }
                },
                { "title": "Name", "className": 'dt-body-left' },
                { "title": "Full Name" },
                { "title": "Originator" }, 
                { "title": "Category" }, 
                { "title": "Status" }, 
                { "title": "Short Description" }
              ]
            });
            console.log(1)
          } else {
            // --- Single Item View Mode ---
            document.getElementById("quest-container").hidden = false;
            
            // 2. Load the specific quest's full detail JSON (e.g., holyavenger.json)
            try {
                quest_data_full = await fetchItemData('https://epcarraway.blob.core.windows.net/dnd/quest/' + quest_key + '.json');
                if (quest_data_full && quest_data_full.quest_chronology) {
                // 2. Assign the value to the new key
                quest_data_full.chronology = quest_data_full.quest_chronology;
                // 3. Delete the old key
                delete quest_data_full.quest_chronology;
              }
            } catch (e) {
                // Fallback to a single synthesized entry if a dedicated JSON file doesn't exist
                const specific_entries = quests_short.filter(i => i.quest_key === quest_key);
                if (specific_entries.length > 0) {
                    // Just pick the entry with the highest originator as the "main" one for the title
                    specific_entries.sort((a, b) => b.originator - a.originator);
                    const main_entry = specific_entries[0];
                    quest_data_full.chronology ??= quest_data_full.quest_chronology;
                    quest_data_full = {
                        name: main_entry.name,
                        name: main_entry.name,
                        originator: main_entry.quest_originator,
                        category: main_entry.category,
                        status: main_entry.status,
                        description: main_entry.short_description,
                        characters: [], // Cannot be determined from short data
                        characteristics: [], // Cannot be determined from short data
                        chronology: quest_data_full.chronology, // Built from all short entries below
                        quest_chronology: quest_data_full.chronology, // Built from all short entries below
                        aliases: [], // Cannot be determined from short data
                        first_ch_num: Math.min(...specific_entries.map(e => e.ch_num)),
                        last_ch_num: Math.max(...specific_entries.map(e => e.ch_num)),
                    };
                } else {
                    document.getElementById("quest-title").innerText = "Item Not Found";
                    return;
                }
            }
            // 3. Populate the Single Item View
            document.getElementById("quest-title").innerText = quest_data_full.name;

            // --- Pre-process Originators for Hyperlinking ---
            let rawOriginators = quest_data_full.quest_originator ?? quest_data_full.quest_originators ?? quest_data_full.originator ?? quest_data_full.originators;
            // Normalize to array (whether it was a string, array, or null)
            let originatorsList = Array.isArray(rawOriginators) ? rawOriginators : (rawOriginators ? [rawOriginators] : []);
            
            let originatorDisplay = "Unknown Originator";
            if (originatorsList.length > 0) {
                originatorDisplay = originatorsList.map(l => {
                    let name = (l || "").trim();
                    // Check if originator name exists in charLinkMap
                    if (charLinkMap.has(name.replace("Tuuki Soltpetar", "Tuuki").replace("Delnis Bricstan", "Delnis"))) {
                        return `<a href="characters.html?c=${charLinkMap.get(name.replace("Tuuki Soltpetar", "Tuuki").replace("Delnis Bricstan", "Delnis"))}">${name}</a>`;
                    }
                    return name;
                }).join(', ');
            }

             // --- Pre-process Location for Hyperlinking ---
            let rawLocations = quest_data_full.locations;
            let locationList = Array.isArray(rawLocations) ? rawLocations : (rawLocations ? [rawLocations] : []);
            
            let locationDisplay = "";
            if (locationList.length > 0) {
                locationDisplay = locationList.map(r => {
                    let rName = (r || "").trim();
                    // Check if location name exists in locLinkMap
                    if (locLinkMap.has(rName)) {
                        return `<a href="locations.html?i=${locLinkMap.get(rName)}">${rName}</a>`;
                    }
                    return rName;
                }).join(', ');
            }

            // --- Pre-process Item for Hyperlinking ---
            let rawItems = quest_data_full.rewards;
            let itemList = Array.isArray(rawItems) ? rawItems : (rawItems ? [rawItems] : []);
            
            let rewardDisplay = "";
            if (itemList.length > 0) {
                rewardDisplay = itemList.map(r => {
                    let rName = (r || "").trim();
                    // Check if item name exists in itemLinkMap
                    if (itemLinkMap.has(rName)) {
                        return `<li><a href="items.html?i=${itemLinkMap.get(rName)}">${rName}</a></li>`;
                    } else {
                        return `<li>${rName}</li>`;
                    }
                    return rName;
                }).join('');
            }

            let htmlContent = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="https://epcarraway.blob.core.windows.net/dnd/quest/${quest_key}.jpg" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x400.jpg?text=No+Image';" class="img-fluid rounded mb-3" style="max-height:400px;">
                        <h4 class="mb-3">${quest_data_full.name}</h4>
                        <div>
                            <l id="quest-aliases" text->
                                 ${Array.isArray(quest_data_full.aliases) && quest_data_full.aliases.length > 0 ? 
                                    quest_data_full.aliases.map(a => `AKA <l>${a}</l>`).join(' ') :
                                    ''}
                            </l>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h2>Description & Lore</h2>
                        <p>${quest_data_full.background}</p>
                        <p id="quest-humorous-desc">${quest_data_full.humorous_description}</p>
                        <hr>
                        <p><strong>Originator:</strong> ${originatorDisplay}</p>
                        <div class="row">
                          <div class="col-md-6">
                          <p><strong>Category:</strong> ${Array.isArray(quest_data_full.category ?? quest_data_full.categories) ? (quest_data_full.category ?? quest_data_full.categories).join(', ') : (quest_data_full.category ?? quest_data_full.categories)}</p>
                          </div>
                          <div class="col-md-6">
                          <p><strong>Status:</strong> ${Array.isArray(quest_data_full.status) ? (quest_data_full.status).join(', ') : (quest_data_full.status)}</p>
                          </div>
                          <div class="col-md-6">
                          <p><strong>Objective:</strong> ${Array.isArray(quest_data_full.objective ?? quest_data_full.objectives) ? (quest_data_full.objective ?? quest_data_full.objectives).join(', ') : (quest_data_full.objective ?? quest_data_full.objectives)}</p>
                          </div>
                          <div class="col-md-6">
                          <p><strong>Importance:</strong> ${Array.isArray(quest_data_full.importance) ? (quest_data_full.importance).join(', ') : (quest_data_full.importance)}</p>
                          </div>
                        </div>
                        <p><strong>Appears In:</strong> Chapter <a href="chapters.html?c=${quest_data_full.first_ch_num}">${quest_data_full.first_ch_num}</a>${quest_data_full.first_ch_num === quest_data_full.last_ch_num ? '' : ` to Chapter <a href="chapters.html?c=${quest_data_full.last_ch_num}">${quest_data_full.last_ch_num}</a>`}</p>
                        <p><strong>Locations:</strong> ${locationDisplay}</p>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                              <h4>Characters</h4>
                              <ul>
                                  ${Array.isArray(quest_data_full.characters) && (quest_data_full.characters.length) > 0 ? 
                                      (quest_data_full.characters).map(a => {
                                          // Extract the name whether 'a' is a string or object
                                          let charName = (a.name || a).trim();
                                          // Check our map to see if we have a key for this name
                                          if (charLinkMap.has(charName.replace("Tuuki Soltpetar", "Tuuki").replace("Delnis Bricstan", "Delnis"))) {
                                              return `<li><a href="characters.html?c=${charLinkMap.get(charName.replace("Tuuki Soltpetar", "Tuuki").replace("Delnis Bricstan", "Delnis"))}">${charName}</a></li>`;
                                          } else {
                                              return `<li>${charName}</li>`;
                                          }
                                      }).join('') :
                                      '<li>Unknown</li>'}
                              </ul>
                            </div>
                            <div class="col-md-6">
                                <h4>Rewards</h4>
                                <ul>
                                    ${rewardDisplay}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <h2>Chronology & Notable Sightings</h2>
                <ul class="list-group">
                    ${quest_data_full.chronology.map(e => 
                        `<li class="list-group-quest"><strong>${e.date}:</strong> ${e.milestone || e.event}</li>`
                    ).join('')}
                </ul>
            `;
            
            document.getElementById("quest-body").innerHTML = htmlContent;
          }
        }
      });
     </script> 
  </body>
</html>